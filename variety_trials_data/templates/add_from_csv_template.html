{% extends "base.html" %}  
{% block content %}
<div class="variety_trials__error">
{% if message %}
	{{ message }}
{% endif %}
</div>

<div>
{% if form %}
<div>
	<h4>Instructions:</h4>
	<p>There are two options:</p>
	<ul>
		<li> Upload a Spreadsheet:</li>
		<ol>
			<!--TODO: auto generate this file from the model-->
			<li> Download the spreadsheet <a href="/static/csv/ndsu_hard_red_spring_wheat_template.csv">template file</a> (300K). </li>
			<li> Enter your data. </li>
			<li> Submit the completed file.</li>
		</ol>
		<li> Paste data into the Spreadsheet below<noscript> (Javascript is required; you seem to have Javascript disabled)</noscript>.</li>
	</ul>
</div>

<form id="variety_trials__spreadsheet_form" enctype="multipart/form-data" action="/add/trial_entry/confirm/" method="POST">
  {% for field in form %}
    <div class="input_row">  
		{% if field.name == 'csv_file' %}
			{% for error in field.errors %}
			<div class="error">
				{{error}}
			</div>
			{% endfor %}
			{{ field.label_tag }}: {{ field }}
		{% else %}
			{{ field }}
		{% endif %}
    </div>
  {% endfor %}
	
	<div id="variety_trials__container" class="input_row" style="display: none;">
		<label for="variety_trials__spreadsheet">Spreadsheet</label>: <div id="variety_trials__spreadsheet" class="dataTable"></div>
	</div>
	<noscript>
	<input type="submit" value="Submit" />
	</noscript>
	<input type="button" id="variety_trials__spreadsheet_submit" style="display: none;" value="Submit" />
</form>
{% endif %}
</div>

{% endblock %}

{% block javascript_imports %}
<script src="/static/js/bootstrap-typeahead.js"></script>
<script src="/static/js/jquery.autoresize.js"></script>
<script src="/static/js/jquery.contextMenu.js"></script>
<script src="/static/js/jquery.ui.position.js"></script>
<script src="/static/js/json2.min.js"></script>
<script src="/static/js/jquery.handsontable.js"></script>
<script src="/static/js/variety_trials_handsontable.js"></script>

<link rel="stylesheet" media="screen" href="/static/css/jquery.contextMenu.css">
<link rel="stylesheet" media="screen" href="/static/css/jquery.handsontable.css">

{% endblock %}

{% block javascript%}

$('#variety_trials__container').show();
$('#variety_trials__spreadsheet_submit').show();

var cols = {{headers|length}};
var variety_trials__headers = [
		{%for field in headers%}"{{field}}", {%endfor%} ""
	];
var spreasheet_container = "#variety_trials__spreadsheet"
var output_container = "#id_csv_json"

variety_trials__init_handsontable(cols, variety_trials__headers, spreasheet_container, output_container);

// Set up an onclick function for the javascript submit button
$('#variety_trials__spreadsheet_submit').click(function(event) {
	// First, select a cell to commit whatever cell is highlighted atm
	setTimeout(function() {
			//timeout is needed because Handsontable normally deselects 
			//current cell when you click outside the table
			$(spreasheet_container).handsontable("selectCell", 0, 0);
	}, 10);
	// Then, submit the form. 
	setTimeout(function() {
			$('#variety_trials__spreadsheet_form').submit();
	}, 20);
});

{% endblock %}
