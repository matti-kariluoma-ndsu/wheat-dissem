{% extends "base.html" %}  
{% block content %}
<div class="variety_trials__error">
{% if message %}
	{{ message }}
{% endif %}
</div>

<div>
	<h4>Instructions:</h4>
	<p>There are two options:</p>
	<ul>
		<li> Upload a Spreadsheet:</li>
		<ol>
			<!--TODO: auto generate this file from the model-->
			<li> Download the spreadsheet <a href="/static/csv/ndsu_hard_red_spring_wheat_template.csv">template file</a> (300K). </li>
			<li> Enter your data. </li>
			<li> Submit the completed file.</li>
		</ol>
		<li> Paste data into the Spreadsheet below<noscript>(Javascript required, you seem to have Javascript disabled)</noscript>.</li>
	</ul>
</div>

<form id="variety_trials__spreadsheet_form" enctype="multipart/form-data" action="/add/trial_entry/confirm/" method="POST">
  {% csrf_token %}
  {% for field in form %}
    <div class="input_row">  
		{% if field.name == 'csv_file' %}
			{% for error in field.errors %}
			<div class="error">
				{{error}}
			</div>
			{% endfor %}
			{{ field.label_tag }}: {{ field }}
		{% else %}
			{{ field }}
		{% endif %}
    </div>
  {% endfor %}
	
	<div id="variety_trials__container" class="input_row" style="display: none;">
		<label for="variety_trials__spreadsheet">Spreadsheet</label>: <div id="variety_trials__spreadsheet" class="dataTable"></div>
	</div>
	<noscript>
	<input type="submit" value="Submit" />
	</noscript>
	<input type="button" id="variety_trials__spreadsheet_submit" style="display: none;" value="Submit" />
</form>
{% endblock %}

{% block javascript_imports %}
<script src="/static/lib/bootstrap-typeahead.js"></script>
<script src="/static/lib/jquery.autoresize.js"></script>
<script src="/static/lib/jQuery-contextMenu/jquery.contextMenu.js"></script>
<script src="/static/lib/jQuery-contextMenu/jquery.ui.position.js"></script>
<script src="/static/js/json2.js"></script>
<script src="/static/js/jquery.handsontable.js"></script>

<link rel="stylesheet" media="screen" href="/static/lib/jQuery-contextMenu/jquery.contextMenu.css">
<link rel="stylesheet" media="screen" href="/static/css/jquery.handsontable.css">

{% endblock %}

{% block javascript%}

$('#variety_trials__container').show();
$('#variety_trials__spreadsheet_submit').show();

var variety_trials__sheet = $("#variety_trials__spreadsheet");
var variety_trials__headers = [
		{%for field in headers%}"{{field}}", {%endfor%} ""
	]

function variety_trials__update_form(changes)
{
	var rows = []
	rows.push(variety_trials__headers);
	var table = variety_trials__sheet.handsontable('getData');
	var row;
	for (i=0; i < table.length; i++)
	{
		row = table[i];
		rows.push(row);
	}
	$('#id_csv_json').val(JSON.stringify(rows));
}

variety_trials__sheet.handsontable({
	rows: 2,
	cols: {{headers|length}},
	minSpareRows: 1,
	contextMenu: true,
	rowHeaders: true,
	colHeaders: variety_trials__headers,
	onChange: variety_trials__update_form
});

var variety_trials__sheet_init_data = [];

variety_trials__sheet.handsontable("loadData", variety_trials__sheet_init_data);

$('#variety_trials__spreadsheet_submit').click(function(event) {
  setTimeout(function() {
      //timeout is needed because Handsontable normally deselects 
      //current cell when you click outside the table
      variety_trials__sheet.handsontable("selectCell", 0, 0);
  }, 10);
  setTimeout(function() {
      //timeout is needed because Handsontable normally deselects 
      //current cell when you click outside the table
      $('#variety_trials__spreadsheet_form').submit();
  }, 20);
});

{% endblock %}
